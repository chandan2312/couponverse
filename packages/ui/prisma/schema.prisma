generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DB_URL")
}

model User {
  id               String  @id @default(auto()) @map("_id") @db.ObjectId
  email            String  @unique
  isEmailVerified  Boolean @default(false)
  avatar           String?
  username         String  @unique
  firstname        String?
  lastname         String?
  gender           String?
  age              Int?
  country          String?
  registeredDomain String?
  role             Role    @default(USER)
  isBot            Boolean @default(false)
  password         String?

  loginMethod  LoginMethod @default(EMAIL)
  ip4          String?
  ip6          String?
  refreshToken String?
  isBanned     Boolean     @default(false)

  subscribedStores Store[]
  coupons          Coupon[]
  offers           Offer[]
  comments         Comment[]

  upvotedOffers   Json[]
  downvotedOffers Json[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index(firstname)
  @@index(lastname)
  @@index(role)
}

enum Role {
  ADMIN
  USER
  EDITOR
}

enum LoginMethod {
  EMAIL
  GOOGLE
  FACEBOOK
}

model Store {
  id                String     @id @default(auto()) @map("_id") @db.ObjectId
  nativeName        String
  slug              String
  sourceImg         String?
  img               String?
  link              String
  affLink           String?
  sourceDescription String?
  description       String?
  bestOffer         String?
  access            String
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @default(now()) @updatedAt
  views             Int        @default(0)
  viewsThreshold    Int        @default(0)
  viewsRecord       Json[]     @default([])
  votes             Int?       @default(0)
  rating            Int?       @default(0)
  popularity        Int?       @default(0)
  address           Address[]
  coupons           Coupon[]
  category          Category[] @relation(fields: [categoryIDs], references: [id])
  categoryIDs       String[]   @db.ObjectId
  batch             Int?
  Offer             Offer[]
  User              User?      @relation(fields: [userId], references: [id])
  userId            String?    @db.ObjectId

  @@index(access)
  @@index(nativeName)
}

model Coupon {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  sourceTitle  String?
  title        String
  englishTitle String?

  sourceDescription String?
  description       String
  shop              String
  offer             String
  englishOffer      String
  code              String?
  type              CouponType
  isVerified        Boolean
  isExpired         Boolean
  expiryDate        String
  sourceId          String?
  access            String
  votes             Int          @default(0)
  rating            Int          @default(0)
  views             Int          @default(0)
  viewsThreshold    Int          @default(0)
  viewsRecord       Json[]       @default([])
  voteHistory       Json[]       @default([])
  scrapeSite        String?
  terms             Json?
  store             Store        @relation(fields: [storeID], references: [id])
  storeID           String       @db.ObjectId
  status            CouponStatus @default(DRAFT)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @default(now()) @updatedAt
  user              User?        @relation(fields: [userID], references: [id])
  userID            String?      @db.ObjectId

  batch Int?

  @@index(access)
  @@index(shop)
}

enum CouponStatus {
  PUBLISHED
  DRAFT
  TRASH
  PENDING
  SPAM
}

enum CouponType {
  CODE
  DEAL
}

model Offer {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  sourceTitle   String
  title         String        @unique
  slug          String        @unique
  description   String?
  sourceImg     String?
  img           String?
  discountPrice Int?
  ogPrice       Int?
  currency      String?
  link          String
  affLink       String?
  shop          String
  offer         String?
  code          String?
  type          CouponType
  access        String
  sourceId      String?
  expiryDate    String?
  isExpired     Boolean?
  scrapeSite    String?
  terms         Json?
  batch         Int?
  status        CouponStatus?

  views          Int?
  viewsThreshold Int?
  viewsArr       Json[] //{userId, date}

  votesThreshold Int?
  upvotes        Int?
  upvotesArr     Json[]
  downvotes      Int? //{userId, date}
  downvotesArr   Json[] //{userId, date}

  store   Store  @relation(fields: [storeID], references: [id])
  storeID String @db.ObjectId

  comments Comment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user   User?   @relation(fields: [userID], references: [id])
  userID String? @db.ObjectId

  tags   Tag[]    @relation(fields: [tagIDs], references: [id])
  tagIDs String[] @db.ObjectId

  @@index(access)
  @@index(shop)
  @@index([shop, access])
  @@index(tagIDs)
  @@index(userID)
}

model Comment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  content   String
  user      User     @relation(fields: [userID], references: [id])
  userID    String   @db.ObjectId
  offer     Offer?   @relation(fields: [offerID], references: [id])
  offerID   String?  @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Tag {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  name         Json
  slug         String   @unique
  slugVariants String[]
  parent       Tag?     @relation("TagToParent", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  parentId     String?  @db.ObjectId
  children     Tag[]    @relation("TagToParent")
  offers       Offer[]  @relation(fields: [offerIDs], references: [id])
  offerIDs     String[] @db.ObjectId
}

model Category {
  id       String   @id @default(auto()) @map("_id") @db.ObjectId
  name     String
  slug     String   @unique
  stores   Store[]  @relation(fields: [storeIDs], references: [id])
  storeIDs String[] @db.ObjectId

  @@index(name)
}

model Address {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  store     Store   @relation(fields: [storeID], references: [id])
  storeID   String  @db.ObjectId
  country   String?
  address   String?
  phone     String?
  email     String?
  website   String?
  facebook  String?
  instagram String?
  twitter   String?
  youtube   String?
  linkedin  String?
  pinterest String?
  tiktok    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}
